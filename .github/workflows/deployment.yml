name: ğŸš€ DÃ©ploiement manuel

on:
  workflow_dispatch:
    inputs:
      reference:
        description: "Branche / Tag / Commit du backend"
        required: true

jobs:
  inputs_validation:
    name: Validation des inputs
    runs-on: ubuntu-latest
    steps:
      - name: Validation
        run: |
          echo "VÃ©rification qu'au moins un tag / commit / branche est renseignÃ©"
          echo "${{ inputs.reference }}" | grep -P '^.+$'

  build_test:
    name: Build & Tests
    runs-on: ubuntu-latest
    needs: inputs_validation

    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: install dependencies
        run: npm install

      - name: build
        run: npm run build
        
      - name: test
        run: npm run test

  deploy:
    name: DÃ©ploiement
    runs-on: ubuntu-latest
    needs: build_test

    env:
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_PORT: ${{ secrets.SSH_PORT }}
      DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}

    steps:
      - name: Chargement des secrets
        run: |
          echo "SSH_USER=$SSH_USER" >> $GITHUB_ENV
          echo "SSH_HOST=$SSH_HOST" >> $GITHUB_ENV
          echo "SSH_PORT=$SSH_PORT" >> $GITHUB_ENV
          echo "DEPLOY_PATH=$DEPLOY_PATH" >> $GITHUB_ENV

      - name: Configuration clÃ© SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets['SSH_PK'] }}" >> ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p $SSH_PORT -H $SSH_HOST >> ~/.ssh/known_hosts

      - name: DÃ©ploiement frontend
        run: |
          ssh $SSH_USER@$SSH_HOST -p $SSH_PORT "
            set -e
            echo 'ğŸ›‘ Stop frontend' && \
            ${{ secrets['STOP_CMD'] }}
            echo 'ğŸ›‘ Stop OK' && \
            echo 'â™»ï¸ Mise Ã  jour repository' && \
            cd $DEPLOY_PATH/code && \
            git fetch && \
            git reset --hard origin/${{ inputs.reference }} && \
            git clean -f && \
            echo 'â™»ï¸ Mise Ã  jour OK' && \
            echo 'ğŸš€ Start frontend' && \
            ${{ secrets['START_CMD'] }}
            echo 'ğŸš€ Start OK'
          "
